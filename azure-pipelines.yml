trigger:
  branches:
    include:
    - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  containerRegistry: 'hub.fliplabs.net'
  backendImage: 'postgresql-app-backend'
  backendDockerfile: 'app-code/backend/Dockerfile'
  backendContext: 'app-code/backend'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Images'
  jobs:
  
  - job: BuildBackend
    displayName: 'Build Backend Image'
    steps:
    
    - task: Docker@2
      displayName: 'Build and Push Backend Image'
      inputs:
        command: buildAndPush
        repository: $(containerRegistry)/$(backendImage)
        dockerfile: $(backendDockerfile)
        buildContext: $(backendContext)
        tags: |
          $(Build.SourceVersion)
          latest

- stage: UpdateManifests
  displayName: 'Update Kubernetes Manifests'
  dependsOn: BuildAndPush
  jobs:
  - job: UpdateManifests
    displayName: 'Update Image Tags'
    steps:
    
    - checkout: self
      persistCredentials: true
    
    - bash: |
        sed -i "s|image: $(containerRegistry)/$(backendImage):.*|image: $(containerRegistry)/$(backendImage):$(Build.SourceVersion)|g" k8s-manifests/base/deployment.yaml
        cat k8s-manifests/base/deployment.yaml | grep "image:"
      displayName: 'Update Backend Image Tag'
    
    - bash: |
        git config user.email "azure-pipeline@devops.com"
        git config user.name "Azure Pipeline Bot"
        git add k8s-manifests/base/deployment.yaml
        git diff --staged --quiet || git commit -m "Update backend image to $(Build.SourceVersion) [skip ci]"
        git push origin HEAD:main
      displayName: 'Commit and Push'
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
