trigger:
  branches:
    include:
    - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  containerRegistry: 'hub.fliplabs.net'
  backendImage: 'postgresql-app-backend'
  backendDockerfile: 'app-code/backend/Dockerfile'
  backendContext: 'app-code/backend'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Images'
  jobs:
  
  # Backend Build Job
  - job: BuildBackend
    displayName: 'Build Backend Image'
    steps:
    
    - task: Docker@2
      displayName: 'Build Backend Image'
      inputs:
        command: build
        repository: $(backendImage)
        dockerfile: $(backendDockerfile)
        buildContext: $(backendContext)
        tags: |
          $(Build.SourceVersion)
          latest
    
    - task: Docker@2
      displayName: 'Push Backend to Registry'
      inputs:
        command: push
        repository: $(containerRegistry)/$(backendImage)
        tags: |
          $(Build.SourceVersion)
          latest

- stage: UpdateManifests
  displayName: 'Update Kubernetes Manifests'
  dependsOn: BuildAndPush
  jobs:
  - job: UpdateManifests
    displayName: 'Update Image Tags'
    steps:
    
    - checkout: self
      persistCredentials: true
    
    - bash: |
        echo "Updating backend deployment manifest..."
        sed -i "s|image: $(containerRegistry)/$(backendImage):.*|image: $(containerRegistry)/$(backendImage):$(Build.SourceVersion)|g" k8s-manifests/base/deployment.yaml
        
        echo "Updated manifest:"
        cat k8s-manifests/base/deployment.yaml | grep "image:"
      displayName: 'Update Backend Image Tag'
    
    - bash: |
        git config --global user.email "azure-pipeline@devops.com"
        git config --global user.name "Azure Pipeline Bot"
        git add k8s-manifests/base/deployment.yaml
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update backend image to $(Build.SourceVersion) [skip ci]"
          git push origin HEAD:main
          echo "Manifest updated and pushed to GitHub"
        fi
      displayName: 'Commit and Push Updated Manifests'
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
